{% extends "base.html" %}

{% block title %}Chatbot Assistant - Parcs Nationaux de Tunisie{% endblock %}

{% block content %}

<!-- Chatbot Header -->
<section class="section" style="padding-top: 120px; background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%); color: white;">
    <div class="container">
        <div class="text-center animate-fade-in-up">
            <div style="font-size: 4rem; margin-bottom: 1rem;">
                <i class="fas fa-robot"></i>
            </div>
            <h1>Assistant Virtuel</h1>
            <p class="text-lg" style="max-width: 600px; margin: 0 auto; opacity: 0.9;">
                Votre guide intelligent pour d√©couvrir les parcs nationaux de Tunisie.
                Posez-moi vos questions sur la faune, la flore, les sentiers ou les urgences.
            </p>
        </div>
    </div>
</section>

<!-- Chat Interface -->
<section class="section">
    <div class="container">
        <div class="chat-container" id="chatContainer">
            <!-- Messages will be added here dynamically -->
            <div class="chat-message bot-message animate-fade-in-up">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">Assistant</span>
                        <span class="message-time" id="botTime1">{{ "now" | strftime("%H:%M") }}</span>
                    </div>
                    <div class="message-text">
                        ü§ñ Bonjour! Je suis votre assistant virtuel pour les Parcs Nationaux de Tunisie.
                        Je peux vous aider avec des informations sur les parcs, la faune, la flore,
                        les sentiers de randonn√©e, la m√©t√©o et les situations d'urgence.
                    </div>
                    <div class="message-suggestions">
                        <button class="suggestion-btn" onclick="sendSuggestion('Liste des parcs nationaux')">Liste des parcs nationaux</button>
                        <button class="suggestion-btn" onclick="sendSuggestion('Animaux √† observer')">Animaux √† observer</button>
                        <button class="suggestion-btn" onclick="sendSuggestion('Sentiers de randonn√©e')">Sentiers de randonn√©e</button>
                        <button class="suggestion-btn" onclick="sendSuggestion('Num√©ros d\'urgence')">Num√©ros d'urgence</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Quick Actions -->
        <div class="emergency-banner" id="emergencyBanner" style="display: none;">
            <div class="emergency-content">
                <div class="emergency-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-text">
                    <h4>üö® Situation d'Urgence D√©tect√©e</h4>
                    <p>Je vais vous guider pour obtenir de l'aide imm√©diatement.</p>
                </div>
                <div class="emergency-actions">
                    <button class="btn btn-primary" onclick="callEmergency('190')">
                        <i class="fas fa-phone"></i> SAMU (190)
                    </button>
                    <button class="btn btn-secondary" onclick="callEmergency('197')">
                        <i class="fas fa-shield-alt"></i> Police (197)
                    </button>
                    <button class="btn btn-outline" onclick="shareLocation()">
                        <i class="fas fa-map-marker-alt"></i> Partager Position
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea
                    id="messageInput"
                    placeholder="Tapez votre message ici... (ex: 'Quels sont les parcs pr√®s de Tunis?' ou 'J\'ai besoin d\'aide d\'urgence')"
                    rows="1"
                    maxlength="500"
                ></textarea>
                <button id="sendButton" class="btn btn-primary" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-hints">
                <small>
                    üí° Essayez: "parcs pr√®s de Tunis", "animaux en danger", "sentiers faciles", "m√©t√©o Ichkeul"
                </small>
            </div>
        </div>
    </div>
</section>

<!-- Emergency Contact Modal -->
<div class="modal-overlay" id="emergencyModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">üö® Confirmation d'Urgence</h3>
            <button class="modal-close" onclick="closeEmergencyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="emergency-contact-form">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Avant d'appeler, partagez votre localisation pour une aide plus rapide.
                </p>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Num√©ro de contact d'urgence (optionnel)
                    </label>
                    <input
                        type="tel"
                        id="emergencyContact"
                        placeholder="+216 XX XXX XXX"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: var(--radius-sm);"
                    >
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Description de la situation
                    </label>
                    <textarea
                        id="emergencyDescription"
                        placeholder="D√©crivez bri√®vement votre situation..."
                        rows="3"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: var(--radius-sm);"
                    ></textarea>
                </div>

                <div class="location-status" id="locationStatus">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Localisation en cours d'acquisition...</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeEmergencyModal()" class="btn btn-outline">Annuler</button>
            <button onclick="confirmEmergency()" class="btn btn-primary">
                <i class="fas fa-phone"></i> Appeler Maintenant
            </button>
        </div>
    </div>
</div>

<style>
/* Chat Styles */
.chat-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    margin-bottom: 2rem;
}

.chat-message {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    border-bottom: 1px solid #f8f9fa;
    animation: slideIn 0.3s ease;
}

.chat-message:last-child {
    border-bottom: none;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: var(--primary);
    color: white;
}

.user-message .message-avatar {
    background: var(--secondary);
    color: white;
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-content {
    align-items: flex-end;
}

.message-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.user-message .message-header {
    justify-content: flex-end;
}

.message-author {
    font-weight: 600;
}

.message-time {
    font-size: 0.75rem;
}

.message-text {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: var(--radius-md);
    line-height: 1.6;
    white-space: pre-line;
}

.user-message .message-text {
    background: var(--primary);
    color: white;
}

.message-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.suggestion-btn {
    background: #e9ecef;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition);
}

.suggestion-btn:hover {
    background: var(--primary);
    color: white;
}

/* Emergency Banner */
.emergency-banner {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    color: white;
    animation: pulse 2s infinite;
}

.emergency-content {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
}

.emergency-icon {
    font-size: 2rem;
}

.emergency-text h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1.25rem;
}

.emergency-text p {
    margin: 0;
    opacity: 0.9;
}

.emergency-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* Chat Input */
.chat-input-container {
    max-width: 800px;
    margin: 0 auto;
}

.chat-input-wrapper {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    background: white;
    border-radius: var(--radius-lg);
    padding: 1rem;
    box-shadow: var(--shadow-md);
}

#messageInput {
    flex: 1;
    border: none;
    outline: none;
    resize: none;
    font-family: inherit;
    font-size: 1rem;
    line-height: 1.4;
    max-height: 120px;
}

#messageInput::placeholder {
    color: var(--text-secondary);
}

#sendButton {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.input-hints {
    margin-top: 0.5rem;
    text-align: center;
    color: var(--text-secondary);
}

/* Location Status */
.location-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.location-status.success {
    background: #d4edda;
    color: #155724;
}

.location-status.error {
    background: #f8d7da;
    color: #721c24;
}

/* Animations */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.8;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .emergency-content {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 1rem;
    }

    .emergency-actions {
        justify-content: center;
    }

    .chat-message {
        padding: 1rem;
        gap: 0.75rem;
    }

    .message-avatar {
        width: 35px;
        height: 35px;
        font-size: 1rem;
    }

    .chat-input-wrapper {
        padding: 0.75rem;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
// Chat functionality
let isEmergencyMode = false;
let currentLocation = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setupChatInput();
    getCurrentLocation();
});

// Setup chat input
function setupChatInput() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendButton');

    // Auto-resize textarea
    input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = input.scrollHeight + 'px';
    });

    // Send on Enter (but allow Shift+Enter for new line)
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Send button
    sendBtn.addEventListener('click', sendMessage);
}

// Send message
async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);

    // Clear input
    input.value = '';
    input.style.height = 'auto';

    // Show typing indicator
    showTypingIndicator();

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                user_id: 'web_user_' + Date.now()
            })
        });

        const data = await response.json();

        // Hide typing indicator
        hideTypingIndicator();

        // Check for emergency
        if (message.toLowerCase().includes('urgence') ||
            message.toLowerCase().includes('emergency') ||
            message.toLowerCase().includes('danger') ||
            message.toLowerCase().includes('accident')) {
            isEmergencyMode = true;
            document.getElementById('emergencyBanner').style.display = 'block';
        }

        // Add bot response
        addMessage('bot', data.response, data.suggestions);

    } catch (error) {
        console.error('Chat error:', error);
        hideTypingIndicator();
        addMessage('bot', 'D√©sol√©, une erreur s\'est produite. Veuillez r√©essayer.');
    }
}

// Send suggestion
function sendSuggestion(text) {
    document.getElementById('messageInput').value = text;
    sendMessage();
}

// Add message to chat
function addMessage(type, text, suggestions = []) {
    const container = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message animate-fade-in-up`;

    const time = new Date().toLocaleTimeString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit'
    });

    messageDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-${type === 'bot' ? 'robot' : 'user'}"></i>
        </div>
        <div class="message-content">
            <div class="message-header">
                <span class="message-author">${type === 'bot' ? 'Assistant' : 'Vous'}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="message-text">${text}</div>
            ${suggestions && suggestions.length > 0 ? `
                <div class="message-suggestions">
                    ${suggestions.map(s => `<button class="suggestion-btn" onclick="sendSuggestion('${s}')">${s}</button>`).join('')}
                </div>
            ` : ''}
        </div>
    `;

    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// Typing indicator
function showTypingIndicator() {
    const container = document.getElementById('chatContainer');
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'chat-message bot-message';
    indicator.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-text">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;

    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// Emergency functions
function callEmergency(number) {
    document.getElementById('emergencyModal').classList.add('active');

    // Pre-fill with current location if available
    if (currentLocation) {
        updateLocationStatus('success', 'Localisation acquise');
    }
}

function closeEmergencyModal() {
    document.getElementById('emergencyModal').classList.remove('active');
}

function confirmEmergency() {
    const contact = document.getElementById('emergencyContact').value;
    const description = document.getElementById('emergencyDescription').value;

    if (currentLocation && contact) {
        // Share location with emergency contact
        shareEmergencyLocation(currentLocation.lat, currentLocation.lng, description, contact);
    }

    // Make the call
    window.location.href = 'tel:190';

    closeEmergencyModal();
}

async function shareEmergencyLocation(lat, lng, message, contactNumber) {
    try {
        await fetch('/api/emergency/location', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                latitude: lat,
                longitude: lng,
                message: message || 'Urgence - Localisation partag√©e',
                contact_number: contactNumber
            })
        });

        addMessage('bot', `‚úÖ Localisation d'urgence partag√©e avec ${contactNumber}. Les secours ont √©t√© alert√©s.`);
    } catch (error) {
        console.error('Error sharing location:', error);
        addMessage('bot', '‚ùå Erreur lors du partage de la localisation.');
    }
}

function shareLocation() {
    if (currentLocation) {
        addMessage('user', `Ma position: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`);
        addMessage('bot', '‚úÖ Position partag√©e. Restez o√π vous √™tes et contactez les secours imm√©diatement.');
    } else {
        addMessage('bot', '‚ùå Impossible d\'obtenir votre position. Activez la g√©olocalisation de votre navigateur.');
        getCurrentLocation();
    }
}

// Location functions
function getCurrentLocation() {
    if (!navigator.geolocation) {
        updateLocationStatus('error', 'G√©olocalisation non support√©e');
        return;
    }

    updateLocationStatus('pending', 'Acquisition de la localisation...');

    navigator.geolocation.getCurrentPosition(
        position => {
            currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            updateLocationStatus('success', 'Localisation acquise');
        },
        error => {
            console.error('Geolocation error:', error);
            updateLocationStatus('error', 'Erreur de g√©olocalisation');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}

function updateLocationStatus(status, message) {
    const statusDiv = document.getElementById('locationStatus');
    if (!statusDiv) return;

    statusDiv.className = `location-status ${status}`;
    statusDiv.innerHTML = `
        <i class="fas fa-map-marker-alt"></i>
        <span>${message}</span>
    `;
}

// Typing dots animation
const style = document.createElement('style');
style.textContent = `
    .typing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .typing-dots span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary);
        animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 60%, 100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
        30% {
            opacity: 1;
            transform: scale(1);
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
