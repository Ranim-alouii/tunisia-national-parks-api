{% extends "base.html" %}

{% block title %}Carte Interactive - Parcs Nationaux de Tunisie{% endblock %}

{% block extra_css %}
<style>
#map {
    height: calc(100vh - 80px);
    width: 100%;
}

.map-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.map-control-btn {
    background: white;
    border: none;
    padding: 12px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    cursor: pointer;
    font-size: 1.25rem;
    color: var(--primary);
    transition: var(--transition);
    width: 50px;
    height: 50px;
}

.map-control-btn:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.05);
}

.map-sidebar {
    position: absolute;
    top: 0;
    left: -400px;
    width: 400px;
    height: 100%;
    background: white;
    box-shadow: var(--shadow-lg);
    z-index: 999;
    transition: left 0.3s ease;
    overflow-y: auto;
}

.map-sidebar.active {
    left: 0;
}

.park-popup {
    min-width: 250px;
}

.park-popup h4 {
    margin: 0 0 0.5rem 0;
    color: var(--primary);
}

.park-popup-meta {
    display: flex;
    gap: 1rem;
    margin: 0.5rem 0;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.park-popup-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.distance-info {
    background: var(--bg-secondary);
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .map-sidebar {
        width: 100%;
        left: -100%;
    }
}
</style>
{% endblock %}

{% block content %}

<div style="position: relative;">
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Map Controls -->
    <div class="map-controls">
        <button class="map-control-btn" onclick="toggleSidebar()" title="Liste des parcs">
            <i class="fas fa-list"></i>
        </button>
        <button class="map-control-btn" onclick="locateMe()" title="Ma position">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="map-control-btn" onclick="fitAllParks()" title="Voir tous les parcs">
            <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" onclick="toggleClustering()" title="Grouper les marqueurs">
            <i class="fas fa-layer-group"></i>
        </button>
    </div>
    
    <!-- Sidebar -->
    <div class="map-sidebar" id="mapSidebar">
        <div style="padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;"><i class="fas fa-mountain"></i> Parcs Nationaux</h3>
                <button onclick="toggleSidebar()" style="background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Search -->
            <div style="margin-bottom: 1rem;">
                <input type="text" 
                       id="mapSearch" 
                       placeholder="Rechercher un parc..."
                       onkeyup="filterParks(this.value)"
                       style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: var(--radius-sm);">
            </div>
            
            <!-- Filter -->
            <div style="margin-bottom: 1.5rem;">
                <select id="governorateFilter" 
                        onchange="filterByGovernorate(this.value)"
                        style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: var(--radius-sm);">
                    <option value="">Tous les gouvernorats</option>
                </select>
            </div>
            
            <!-- Parks List -->
            <div id="parksList">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let map;
let markers = [];
let allParks = [];
let userLocation = null;
let clusteringEnabled = false;
let markerClusterGroup = null;

// Initialize map
async function initMap() {
    // Create map centered on Tunisia
    map = L.map('map').setView([34.0, 9.5], 7);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Load parks
    await loadParks();
    
    // Try to get user location
    tryGetUserLocation();
}

// Load all parks
async function loadParks() {
    try {
        const response = await fetch('/api/parks');
        allParks = await response.json();
        
        // Populate governorate filter
        populateGovernorateFilter();
        
        // Add markers
        addMarkers(allParks);
        
        // Populate sidebar list
        populateParksList(allParks);
        
    } catch (error) {
        console.error('Error loading parks:', error);
        appUtils.showNotification('Erreur lors du chargement des parcs', 'error');
    }
}

// Add markers to map
function addMarkers(parks) {
    // Clear existing markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    parks.forEach(park => {
        // Custom icon
        const icon = L.divIcon({
            html: `<div style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-md);">
                <i class="fas fa-tree" style="transform: rotate(45deg); font-size: 1.25rem;"></i>
            </div>`,
            className: 'custom-marker',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        });
        
        // Create marker
        const marker = L.marker([park.latitude, park.longitude], { icon })
            .bindPopup(createPopupContent(park), {
                maxWidth: 300,
                className: 'park-popup'
            });
        
        marker.parkData = park;
        markers.push(marker);
        marker.addTo(map);
        
        // Add click event
        marker.on('click', () => {
            highlightParkInList(park.id);
        });
    });
}

// Create popup content
function createPopupContent(park) {
    const distance = userLocation 
        ? appUtils.calculateDistance(
            userLocation.lat, 
            userLocation.lng, 
            park.latitude, 
            park.longitude
        ).toFixed(1)
        : null;
    
    return `
        <div class="park-popup">
            <h4>${park.name}</h4>
            <div class="park-popup-meta">
                <span><i class="fas fa-map-marker-alt"></i> ${park.governorate}</span>
                <span><i class="fas fa-ruler-combined"></i> ${park.area_km2} km²</span>
            </div>
            ${distance ? `
                <div class="distance-info">
                    <i class="fas fa-route"></i> À ${distance} km de votre position
                </div>
            ` : ''}
            <p style="margin: 0.75rem 0; color: var(--text-secondary); font-size: 0.875rem;">
                ${park.description.substring(0, 100)}...
            </p>
            <div class="park-popup-actions">
                <button onclick="goToPark(${park.id})" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i> Voir
                </button>
                <button onclick="getDirectionsToPark(${park.latitude}, ${park.longitude})" class="btn btn-outline btn-sm">
                    <i class="fas fa-directions"></i> Itinéraire
                </button>
            </div>
        </div>
    `;
}

// Populate governorate filter
function populateGovernorateFilter() {
    const governorates = [...new Set(allParks.map(p => p.governorate))].sort();
    const select = document.getElementById('governorateFilter');
    
    governorates.forEach(gov => {
        const option = document.createElement('option');
        option.value = gov;
        option.textContent = gov;
        select.appendChild(option);
    });
}

// Populate parks list in sidebar
function populateParksList(parks) {
    const container = document.getElementById('parksList');
    
    if (parks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Aucun parc trouvé</p>';
        return;
    }
    
    container.innerHTML = parks.map(park => {
        const distance = userLocation 
            ? appUtils.calculateDistance(
                userLocation.lat, 
                userLocation.lng, 
                park.latitude, 
                park.longitude
            ).toFixed(1)
            : null;
        
        return `
            <div class="card hover-lift" 
                 id="park-list-${park.id}"
                 onclick="focusPark(${park.id})" 
                 style="margin-bottom: 1rem; cursor: pointer;">
                <div class="card-content">
                    <h4 style="margin-bottom: 0.5rem;">${park.name}</h4>
                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                        <i class="fas fa-map-marker-alt"></i> ${park.governorate}
                        ${distance ? `<span style="margin-left: 0.5rem;"><i class="fas fa-route"></i> ${distance} km</span>` : ''}
                    </p>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="event.stopPropagation(); goToPark(${park.id})" class="btn btn-primary btn-sm">
                            Voir
                        </button>
                        <button onclick="event.stopPropagation(); getDirectionsToPark(${park.latitude}, ${park.longitude})" class="btn btn-outline btn-sm">
                            <i class="fas fa-directions"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Focus on a specific park
function focusPark(parkId) {
    const park = allParks.find(p => p.id === parkId);
    if (!park) return;
    
    map.setView([park.latitude, park.longitude], 12);
    
    // Find and open marker popup
    const marker = markers.find(m => m.parkData.id === parkId);
    if (marker) {
        marker.openPopup();
    }
}

// Highlight park in list
function highlightParkInList(parkId) {
    // Remove previous highlights
    document.querySelectorAll('[id^="park-list-"]').forEach(el => {
        el.style.borderLeft = 'none';
    });
    
    // Highlight selected
    const element = document.getElementById(`park-list-${parkId}`);
    if (element) {
        element.style.borderLeft = '4px solid var(--primary)';
        element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Filter parks by search
function filterParks(searchTerm) {
    const filtered = allParks.filter(park => 
        park.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        park.governorate.toLowerCase().includes(searchTerm.toLowerCase()) ||
        park.description.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    addMarkers(filtered);
    populateParksList(filtered);
}

// Filter by governorate
function filterByGovernorate(governorate) {
    const filtered = governorate 
        ? allParks.filter(p => p.governorate === governorate)
        : allParks;
    
    addMarkers(filtered);
    populateParksList(filtered);
    
    // Fit bounds to filtered parks
    if (filtered.length > 0) {
        const bounds = L.latLngBounds(filtered.map(p => [p.latitude, p.longitude]));
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

// Toggle sidebar
function toggleSidebar() {
    document.getElementById('mapSidebar').classList.toggle('active');
}

// Fit all parks
function fitAllParks() {
    if (markers.length > 0) {
        const bounds = L.latLngBounds(markers.map(m => m.getLatLng()));
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

// Locate user
async function locateMe() {
    try {
        const location = await appUtils.getCurrentLocation();
        userLocation = location;
        
        // Add user marker
        if (window.userMarker) {
            map.removeLayer(window.userMarker);
        }
        
        const userIcon = L.divIcon({
            html: '<div style="background: #4895ef; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: var(--shadow-md);"><i class="fas fa-user"></i></div>',
            className: 'user-marker',
            iconSize: [30, 30]
        });
        
        window.userMarker = L.marker([location.lat, location.lng], { icon: userIcon })
            .bindPopup('Vous êtes ici')
            .addTo(map);
        
        map.setView([location.lat, location.lng], 9);
        
        // Update popups with distances
        markers.forEach(marker => {
            marker.setPopupContent(createPopupContent(marker.parkData));
        });
        
        // Update list
        populateParksList(allParks);
        
        appUtils.showNotification('Position trouvée!', 'success');
        
    } catch (error) {
        console.error('Geolocation error:', error);
        appUtils.showNotification('Impossible d\'obtenir votre position', 'error');
    }
}

// Try to get user location on load
function tryGetUserLocation() {
    navigator.geolocation?.getCurrentPosition(
        position => {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            populateParksList(allParks);
        },
        () => {} // Fail silently
    );
}

// Toggle clustering
function toggleClustering() {
    clusteringEnabled = !clusteringEnabled;
    
    if (clusteringEnabled) {
        appUtils.showNotification('Clustering activé', 'info');
        // Note: Requires leaflet.markercluster plugin
    } else {
        appUtils.showNotification('Clustering désactivé', 'info');
    }
}

// Navigate to park page
function goToPark(parkId) {
    window.location.href = `/parks/${parkId}`;
}

// Get directions
function getDirectionsToPark(lat, lng) {
    if (userLocation) {
        window.open(
            `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${lat},${lng}`,
            '_blank'
        );
    } else {
        window.open(
            `https://www.google.com/maps?q=${lat},${lng}`,
            '_blank'
        );
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
